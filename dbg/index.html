<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—Ö–æ–¥ –∏ —Ç—Ä–µ–∫–µ—Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .setup-screen, .login-form, .app-content {
            display: none;
        }
        
        .setup-screen.active, .login-form.active, .app-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        input[type="text"],
        input[type="password"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
            margin-top: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .logout-btn {
            background: #e74c3c;
            width: auto;
            padding: 8px 20px;
            font-size: 14px;
            float: right;
        }
        
        .summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 30px 0;
        }
        
        .summary h2 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 20px;
        }
        
        .sum-display {
            font-size: 32px;
            color: #333;
            font-weight: bold;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.active {
            display: block;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .user-info {
            color: #666;
        }

        .info-box {
            background: #e8f4fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .info-box h3 {
            color: #1976D2;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .info-box p, .info-box ol {
            color: #555;
            line-height: 1.6;
            margin: 5px 0;
        }

        .info-box ol {
            margin-left: 20px;
        }

        .info-box code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 14px;
        }

        .info-box a {
            color: #1976D2;
            text-decoration: none;
        }

        .info-box a:hover {
            text-decoration: underline;
        }

        small {
            color: #888;
            display: block;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup Screen -->
        <div class="setup-screen active">
            <h1>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub (–æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ)</h1>
            
            <div class="info-box">
                <h3>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –±—ã—Å—Ç—Ä–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ:</h3>
                <ol>
                    <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ <a href="https://github.com/new" target="_blank">GitHub</a> –∏ —Å–æ–∑–¥–∞–π—Ç–µ <strong>–ø—Ä–∏–≤–∞—Ç–Ω—ã–π</strong> —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, "tracker-data")</li>
                    <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <a href="https://github.com/settings/tokens/new" target="_blank">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub ‚Üí Developer Settings ‚Üí Personal Access Tokens ‚Üí Tokens (classic)</a></li>
                    <li>–ù–∞–∂–º–∏—Ç–µ "Generate new token (classic)"</li>
                    <li>–î–∞–π—Ç–µ –∏–º—è, –Ω–∞–ø—Ä–∏–º–µ—Ä "Tracker App"</li>
                    <li>–û—Ç–º–µ—Ç—å—Ç–µ —Ç–æ–ª—å–∫–æ –æ–±–ª–∞—Å—Ç—å <code>repo</code> (–ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏)</li>
                    <li>–ù–∞–∂–º–∏—Ç–µ "Generate token" –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ —Å—Ä–∞–∑—É (–≤—ã –Ω–µ —É–≤–∏–¥–∏—Ç–µ –µ–≥–æ —Å–Ω–æ–≤–∞!)</li>
                </ol>
            </div>

            <div id="setupMessage" class="message"></div>
            
            <div class="form-group">
                <label for="githubToken">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ GitHub</label>
                <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                <small>–ë—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ</small>
            </div>

            <div class="form-group">
                <label for="githubRepo">–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (—Ñ–æ—Ä–º–∞—Ç: –∏–º—è–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/–∏–º—è-—Ä–µ–ø–æ)</label>
                <input type="text" id="githubRepo" placeholder="–≤–∞—à–µ-–∏–º—è/tracker-data">
                <small>–ü—Ä–∏–º–µ—Ä: pashka/tracker-data</small>
            </div>
            
            <button onclick="saveGitHubConfig()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>

        <!-- Login Form -->
        <div class="login-form">
            <h1>üîê –ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥</h1>
            <div id="loginMessage" class="message"></div>
            <div class="form-group">
                <label for="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                <input type="text" id="username" placeholder="–ª—é–±–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" autocomplete="username">
            </div>
            <div class="form-group">
                <label for="password">–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="password" placeholder="–ª—é–±–æ–π –ø–∞—Ä–æ–ª—å" autocomplete="current-password">
            </div>
            <button onclick="quickLogin()">–í–æ–π—Ç–∏ / –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <small style="text-align: center; margin-top: 10px;">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç –∞–∫–∫–∞—É–Ω—Ç, –µ—Å–ª–∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</small>
        </div>

        <!-- App Content -->
        <div class="app-content">
            <div class="header-bar">
                <h1>üìä –¢—Ä–µ–∫–µ—Ä —á–∏—Å–µ–ª</h1>
                <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
            <div class="user-info">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <strong id="currentUser"></strong></div>
            
            <div id="appMessage" class="message"></div>
            
            <div class="form-group">
                <label for="number">–ß–∏—Å–ª–æ</label>
                <input type="number" id="number" placeholder="–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ" step="0.01">
            </div>
            <div class="form-group">
                <label for="note">–ó–∞–º–µ—Ç–∫–∞</label>
                <textarea id="note" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä–æ—Ç–∫—É—é –∑–∞–º–µ—Ç–∫—É"></textarea>
            </div>
            <button onclick="addEntry()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
            
            <div class="summary">
                <h2>–û–±—â–∞—è —Å—É–º–º–∞</h2>
                <div class="sum-display" id="totalSum">0</div>
            </div>
            
            <h2 style="margin-top: 30px; color: #333;">–í–∞—à–∏ –∑–∞–ø–∏—Å–∏</h2>
            <table id="entriesTable">
                <thead>
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–ß–∏—Å–ª–æ</th>
                        <th>–ó–∞–º–µ—Ç–∫–∞</th>
                    </tr>
                </thead>
                <tbody id="entriesBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentUser = null;
        let config = {
            token: null,
            repo: null,
            fileSha: null
        };

        window.addEventListener('DOMContentLoaded', () => {
            const savedConfig = localStorage.getItem('githubConfig');
            if (savedConfig) {
                config = JSON.parse(savedConfig);
                showScreen('login-form');
            } else {
                showScreen('setup-screen');
            }
        });

        function showScreen(screen) {
            document.querySelectorAll('.setup-screen, .login-form, .app-content').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector('.' + screen).classList.add('active');
        }

        async function saveGitHubConfig() {
            const token = document.getElementById('githubToken').value.trim();
            const repo = document.getElementById('githubRepo').value.trim();
            
            if (!token || !repo) {
                showMessage('setupMessage', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è', 'error');
                return;
            }

            if (!repo.includes('/')) {
                showMessage('setupMessage', '–§–æ—Ä–º–∞—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: –∏–º—è–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/–∏–º—è-—Ä–µ–ø–æ', 'error');
                return;
            }

            config.token = token;
            config.repo = repo;

            try {
                await loadDataFromGitHub();
                localStorage.setItem('githubConfig', JSON.stringify(config));
                showMessage('setupMessage', '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
                setTimeout(() => showScreen('login-form'), 1500);
            } catch (error) {
                showMessage('setupMessage', '–û—à–∏–±–∫–∞: ' + error.message + '. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à —Ç–æ–∫–µ–Ω –∏ –∏–º—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.', 'error');
            }
        }

        async function loadDataFromGitHub() {
            const url = `https://api.github.com/repos/${config.repo}/contents/data.json`;
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${config.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.status === 404) {
                    const initialData = { users: {} };
                    await saveDataToGitHub(initialData);
                    return initialData;
                } else if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ GitHub API: ' + response.status);
                }

                const fileData = await response.json();
                config.fileSha = fileData.sha;
                
                const content = atob(fileData.content);
                return JSON.parse(content);
            } catch (error) {
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ GitHub: ' + error.message);
            }
        }

        async function saveDataToGitHub(data) {
            const url = `https://api.github.com/repos/${config.repo}/contents/data.json`;
            const content = btoa(JSON.stringify(data, null, 2));
            
            const body = {
                message: '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–µ—Ä–∞',
                content: content
            };

            if (config.fileSha) {
                body.sha = config.fileSha;
            }

            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${config.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ GitHub –Ω–µ —É–¥–∞–ª–æ—Å—å: ' + (error.message || response.status));
            }

            const result = await response.json();
            config.fileSha = result.content.sha;
            localStorage.setItem('githubConfig', JSON.stringify(config));
        }

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function quickLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showMessage('loginMessage', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å', 'error');
                return;
            }
            
            try {
                const allData = await loadDataFromGitHub();
                const passwordHash = await hashPassword(password);

                if (!allData.users[username]) {
                    allData.users[username] = {
                        passwordHash: passwordHash,
                        entries: []
                    };
                    await saveDataToGitHub(allData);
                    showMessage('loginMessage', '–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Ö–æ–¥...', 'success');
                } else {
                    if (allData.users[username].passwordHash !== passwordHash) {
                        showMessage('loginMessage', '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
                        return;
                    }
                }
                
                currentUser = username;
                document.getElementById('currentUser').textContent = username;
                setTimeout(() => {
                    showScreen('app-content');
                    loadEntries();
                }, 1000);
            } catch (error) {
                showMessage('loginMessage', '–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showScreen('login-form');
        }

        async function addEntry() {
            const number = parseFloat(document.getElementById('number').value);
            const note = document.getElementById('note').value.trim();
            
            if (isNaN(number)) {
                showMessage('appMessage', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ', 'error');
                return;
            }
            
            if (!note) {
                showMessage('appMessage', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∑–∞–º–µ—Ç–∫—É', 'error');
                return;
            }
            
            try {
                const allData = await loadDataFromGitHub();
                
                const entry = {
                    date: new Date().toISOString(),
                    number: number,
                    note: note
                };
                
                allData.users[currentUser].entries.push(entry);
                await saveDataToGitHub(allData);
                
                document.getElementById('number').value = '';
                document.getElementById('note').value = '';
                
                showMessage('appMessage', '–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!', 'success');
                await loadEntries();
            } catch (error) {
                showMessage('appMessage', '–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        async function loadEntries() {
            try {
                const allData = await loadDataFromGitHub();
                const entries = allData.users[currentUser].entries || [];
                
                const sum = entries.reduce((acc, entry) => acc + entry.number, 0);
                document.getElementById('totalSum').textContent = sum.toFixed(2);
                
                const tbody = document.getElementById('entriesBody');
                tbody.innerHTML = '';
                
                [...entries].reverse().forEach(entry => {
                    const row = tbody.insertRow();
                    const dateCell = row.insertCell(0);
                    const numberCell = row.insertCell(1);
                    const noteCell = row.insertCell(2);
                    
                    dateCell.textContent = formatDate(entry.date);
                    numberCell.textContent = entry.number.toFixed(2);
                    noteCell.textContent = entry.note;
                });
            } catch (error) {
                showMessage('appMessage', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π: ' + error.message, 'error');
            }
        }

        function showMessage(elementId, text, type) {
            const messageEl = document.getElementById(elementId);
            messageEl.textContent = text;
            messageEl.className = `message ${type} active`;
            setTimeout(() => {
                messageEl.classList.remove('active');
            }, 3000);
        }

        document.getElementById('password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') quickLogin();
        });
    </script>
</body>
</html>